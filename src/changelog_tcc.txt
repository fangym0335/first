# Changelog.txt
# Create @ 2008-03-23

# ------------------ 版本说明 -------------------- #
Version: 1.06.3000(2009-08-31)
  第一批推广部署版本
Version: 1.06.2700(2009-02-06)
  1130更新版本,3月份更新现场
Version: 1.06.2600(2008-10-22)
  1130第二个版本
Version: 1.06.2500(2008-09-01)
  1130第一个版本
  For SIT 9.1 以及 9.4 630升级
Version: 1.06.2300(2008-07-31)
  For SIT 第一阶段测试
Version: 1.06.2200(2008-07-18)
  添加稳定的模拟加油机模块
Version: 1.06.1906(2008-07-05)
  630最终版本RC1
Version: 1.06.1905(2008-06-27)
  630最终版本RC
Version: 1.06.18 (2008-06-22)
  622试点第二批发布版本
Version: 1.06.12 (2008-06-10)
  610上站使用版本
Version: 1.06.10 (2008-05-30)
  630最终版本
Version: 1.06.09 (2008-05-28)
  第三个测试版本
Version: 1.06.08 (2008-05-20)
  第二个测试版本
Version: 1.06.06 (2008-05-10)
  准入测试正式版本

# ----------------  修改说明 --------------------- #
2010-06-09 (1.06.5400)1.06.54
[MOD]修改豪升模块多枪枪号处理(原豪升多枪协议中的枪号定义与单枪机
的实现有冲突--单枪机用了该字节表示打印枪号,但没有定义到协议中)
[MOD]增加对OPW_ISITE液位仪的支持;
[ADD]添加李镭的二配B方案dlb_main.c到工程中;
2010-04-09 (1.06.5024)1.06.5301/1.06.53
[MOD]去掉IO版本信息中的换行;
[FIX]恒山模块变价失败提示信息错位(0x36与0x37的错误类型描述相反);
2010-03-24 (1.06.5023)
[MOD]修改掉电处理, 只在掉电开始时备份日志;
2010-03-12 (1.06.5022)
[ADD]添加listconfig.c用于列出油品油枪配置
[MOD]修改ReadIOVersion, IO口数也记录到io.ver;
[MOD]更新cgidumpshm.c, Makefile, 默认每次都编译cgidumpshm;
2010-02-26 (1.06.5021)1.06.5300
[FIX]太空模块DoPolling断线恢复联系处增加是否离线30秒的判断处理;
2010-02-25 (1.06.5020)
[FIX]修正恒山模块变价错误提示信息错位(37与36的提示信息相反);
[MOD]修改price_change_track中fp_fm_data的索引([][0] -> [][default_fm - 1]);
2010-02-02 (1.06.5019)
[FIX]长吉模块DoBusy中Default_Fuelling_Mode索引错误(i->pos);
[FIX]榕兴\宝德尔\老长空模块DoEot读取单价失败的情况下Default_FM索引错误;
2010-01-28 (1.06.5018)
[MOD]修改太空变长处理(spec.c case 0x03);
2010-01-27 (1.06.5017)
[MOD]调整了所有油机模块变价失败的重试时间间隔;
[MOD]太空模块对抬枪已授权之后快速挂抬枪做了补充处理;
2010-01-04 (1.06.5016)
[FIX]修正exp2float中计算e时的一个错误-没有将(data[0] << 1) | (data[1] >>
7)显示转换为unsigned char, 导致在数据为负(温度)的情况下数据错误.
使用VR协议的模块均有影响;
[FIX]预置失败的情况下没有清除预置量(比如抬枪状态预置),
导致重新抬枪被认为是预置,一直不能授权成功(涉及所有油机模块);
2009-12-29 (1.06.5015)
[MOD]lischn007增加变价反馈,
但没有增加在Inoperative状态下查询单价并恢复状态的处理,因为油机不能读取单价;
[FIX]修正lischn019中变价反馈第二个FP的error code数量错误问题;
2009-12-23 (1.06.5014)
[MOD]修正ifsf_dspfp.c中几处执行预置等命令时的状态判断错误(fp_state != 3 ||
fp_state != 4 ---> fp_sate != 3 && f_state != 4);
2009-12-22 (1.06.5013)
[MOD]修改lischn007和lisch019中Default_Fuelling_Mode - 1为fm_idx;
[MOD]lischn019添加变价反馈处理&和变价失败后自动检测单价恢复状态的处理;
2009-12-16 (1.06.5012)
[ADD]添加restart_daemon.c //自动重启工具
2009-12-15 (1.06.5012)
[MOD]修改spec.c中榕兴接收数据长度处理,
避免cmd[2]机不是35也不是39的情况下导致只接收3个字节的问题;
[FIX]修正长吉模块金额预置LRC校验计算长度错误问题;
2009-12-11 (1.06.5011)
[MOD]同步李镭变价修改lischn003-06,08-18,20(剩余lischn007,019);
[FIX]抬枪状态下发预置的情况下,
进行了错误处理之后未清除预置量,导致之后PAK也不能正常授权(涉及所有模块);
2009-12-08 (1.06.5010)
[MOD]同步李镭变价修改lischn001,02;
2009-12-06 (1.06.5009)
[MOD]修改豪升模块DoRation指定枪号错误(油机枪号为0/1对应1/2);
[MOD]DoRation后恢复Log_Noz_Mask的设置;
2009-12-01 (1.06.5007)
[MOD]合并李镭对豪升模块的变价修改;
[MOD]豪升模块按照双枪协议修改与枪号相关的处理;
2009-11-29 (1.06.5006)
[MOD]修改恒山模块, 对下发命令的校验字节为0xFF的情况增加转义处理;
2009-11-20 (1.06.5005)
[MOD]修改恒山TMC模块(lischn019)油枪数初始化处理, 初始化各FP油枪数为4;
[MOD]恒山TMC模块在Pr_no值不在正常范围内的异常处理, 避免数组越界;
2009-11-09 (1.06.5004)
[FIX]修正恒山变价反馈中error code错误
2009-11-05 (1.06.5003)
[MOD]修改恒山/模拟油机模块lischn016的变价反馈处理,解决Fuel同时下发通条同种油品变价命令的情况下,
反馈的error code数目不够的问题;
2009-11-04 (1.06.5002)
[MOD]添加了变价成功反馈处理(ifsf_dsper.c/lischn016/lischn002);
[MOD]博瑞特模块去除两条日志(tank_brite.c);
2009-11-03 (1.06.5000)
[MOD]恒山模块增加CheckPriceErr检查变价失败后单价是否已经人工修改正确,
若正确则恢复FP状态为Closed;
[MOD]恒山模块在变价执行成功后返回增加发送Error Code 0x99 给Fuel
server表示变价执行成功;

[MOD]放开Nb_Fuelling_Modes/Default_Fuelling_Mode/Fuelling_Mode的写允许;
[MOD]修改BeginTr4Fp/DefaultFM_DAT/ReadFM_DATA/WriteFM_DATA/TranslateRecv中与fm相关的处理,
数组索引均使用实际的Fuelling_MOde代替(原来固定为0);
[MOD]变价处理(WriteFM.case Prod_Price), 直接更新单价到数据库,不再等待lischn执行成功之后再更新;
[FIX]TransRevFM中对FM_ID==0x10对处理(由近仅处理0x11, 改为遍历处理0x11-0x18);
[FIX]EndTr4FP完成交易处理后将Default_Fuelling_Mode赋值给Fuelling_Mode;
[MOD]完善离线交易处理(排序,隐患排除等);
[FIX]修正模拟加油机1.0模块中意外退出后node_online标记没有复位,
导致即使不再连接模拟加油机也发送心跳的问题;
2009-11-02 (1.06.3010)
[MOD]放开太空/豪升/三盈模块变价成功读单价判断的处理(测试OK);
[MOD]模拟加油机1.0程序改为lischn020, 与1.06.30保持一致;
[MOD]蓝峰模块由lischn020改为lischn017(覆盖原正星CS6300);
2009-10-12 (1.06.3008)
[MOD]移除tank_opw, tank_opw_pv4中对INTERVAL的重复定义;
[MOD]lischn.c添加模拟油机1.0模块为lischn021;
2009-10-09 (1.06.3007)
[FIX]修正太空模块DoBusy中status无确定值的缺陷,
当status为1的情况下会导致FP状态无法改变为Fuelling, 然后Fuel下发Terminate_FP.
2009-09-27 (1.06.3006)
[MOD]增加蓝峰模块(lischn020)
2009-09-23 (1.06.3005)
[FIX]三盈模块变价bug--memcpy(tempprice, pump.newPrice, 4),
newPrice后没有指定元素, 单价倒数计算错误;
[MOD]ReadIOVersion增加补发1C50命令的处理, 确保不会引发老版本1C45命令没有结束的bug.
2009-09-08 (1.06.3004)
[MOD]反馈读全部油品配置时(eg. 400203)返回全部8个地址的信息,
而不是跟据油品数量反馈, 因为有效配置不一定连续;
[MOD]Prod_Nb/Prod_Descritpion的处理增加是否有重复项的判断(油品配置要求唯一性);
2009-09-07 (1.06.3003)
[FIX]模拟油机模块修正了多枪读泵码和变价问题;
2009-09-04 (1.06.3002)
[FIX]InitAll中对NodeRecCount增加初始化;
2009-08-31 (1.06.3001)
[MOD]同时支持模拟加油机1.0版本(lischn020);
2009-08-31 (1.06.3000)****
[MOD]1.06.2778版本号修改为1.06.30/1.06.3000 2009.08.31, 作为新的发布版本.
2009-08-30 (1.06.2778)
[MOD]宝德尔模块增加判断--如果没有授权油机状态就变为"加油中",
那么就设置一下主控(避免轮询命令畸变未取消主控命令造成的影响);
[MOD]老长空非卡机模块(lischn010)做与宝德尔模块同样的处理;
[FIX]各个模块在离线恢复处理处均增加fail_cnt = 0,以复位该变量,
因为等待30s的时会将fail_cnt自减至负值, 若不复位将影响下次离线判断;
2009-08-29 (1.06.2777)
[ADD]pub.c增加初始化wayne_rcap2l_flag的初始化处理,启动时读取IO程序版本号,
然后判断是否支持1c45命运, 并设置
wayne_rcap2l_flag;若不支持则为稳牌模块SetRCAP2L函数不会下发设置命令给IO板.
2009-08-28 (1.06.2776)
[MOD]tty.c增加测试代码,
打印接收信息过程日志(用于测试金福站全部油枪突然通讯失败问题)
2009-08-27 (1.06.2775)
[MOD]新的模拟加油机模块(模拟加油机2.0)
2009-08-25 (1.06.2774)
[MOD]榕兴模块DoEot时机稍作调整--34状态不执行DoEot,
因为油机可能还没有完成数据处理;
2009-08-24 (1.06.2773)
[MOD]AddTR_DATA中对fp_offline_flag判断后增加日志输出;
[MOD]稳牌模块SetRCAP2L增加使用限制说明(对IO版本有要求);
2009-08-21 (1.06.2772) 1.06.29 换号测试版本
[MOD]init.c-initAll中增加初始化所有油品到Node的油品数据库的处理-(临时性处理,
适应RTX系统当前实现--换号要求Prod DB中已经配置了目标油品);
[MOD]WriteTP_DAT中写Prod_Nb, Prod_Description时忽略状态判断(临时性处理,
适应RTX系统当前实现--下发命令修改这两个Data_Id, 但是没有事先切换液位仪模式);
2009-08-16 (1.06.2771)
[FIX]原Read_DATA中LNAR,LNAO为固定值
2009-08-12 (1.06.2770)
[MOD]日志转储改回原来的方式--先写入内存, 然后定时转储到nand
2009-08-11 (1.06.2769) 待验证版本 (由2768验证)
[MOD]恒山UDC协议模块修改case FP_IDEL时的处理顺序,
完成交易处理之后再发送挂枪确认.
2009-08-11 (1.06.2768) 测试专用
[MOD]恒山UDC协议模块增加测试代码, 用于现场测试抬枪状态读泵码是否能够成功.
2009-08-10 (1.06.2767)
[MOD]宝德尔模块预置处理改为抬枪之后下发;
2009-08-07 (1.06.2766)
[FIX]initAll中初始化油品数量cntOfProd有误.
[MOD]修改WriteLNZ_DATA, 修改LNZ数据库的PR_Id后增加同步配置到配置文件的处理;
2009-08-06 (1.06.2765)
[MOD]长吉模块DoStarted/DoCall的调用做了一些调整--对执行结果进行判断处理;
2009-08-05 (1.06.2764)
[FIX]DefaultPR函数中初始化Prod_Nb错误,现将其移除, 保持初始值为零.
对应的init.c中新增油品前对Pord_Nb是否为空的判断条件也做了调整;
2009-07-19 (1.06.2763)
[MOD]长吉模块预置处理改为抬枪后下发,
空闲时连发三次预置的方式会导致预置处理时间过长;
2009-07-19 (1.06.2762)
[MOD]长吉模块预置时间间隔调长, 保证2x命令间隔达到2s;
2009-07-19 (1.06.2761)
[MOD]中意模块DoOpen/DoClose修改为跟其他模块一样的处理--不给油机发送实际的解锁/锁枪命令,
目前并不必要,所以化繁为简;
[MOD]稳牌模块修改GetPumpMsg的返回值处理, 返回不同信息时返回值不同,
以便调用者判断是否得到期望的数据;
2009-07-18 (1.06.2760)
[MOD]移除了各个模块变价命令重发时间2s的处理,
变价失败重试之延迟500ms,原来没有读取单价进行确认判断的模块仍然保持原样,
(变价处理的修改还需要更多的测试);
[MOD]因宝德尔与老长空协议以及实现一样(都是蓝天电脑板), 所以将lischn010.c
替换为lischn006.c, 原来两者的区别是lischn010.c是抬枪后下发预置;
2009-07-18 (1.06.2759)
[MOD]中意模块GetTransData做了一点修改--回复交易确认的时候不使用pump.cmd,
而是另外定义cmd数组, 避免影响到pump.cmd中的交易数据;
[FIX]DefaultC_DATA中正确初始化SW_Checksum;
[FIX]ReadC_DATA 中W&M_Polynomial, W&M_Seed修正为不可读;
2009-07-08 (1.06.2757)
[MOD]修改UDC模块预置加油处理, 增加对限定枪号的处理;
[MOD]修改UDC模块变价处理, 加快处理速度;
2009-07-06 (1.06.2756)
[MOD]恒山UDC模块变价处理增加等待其他油品变价命令的处理,
以便同一个面各油品的新单价一起下发;
[MOD]恒山UDC模块授权DoAuth中预置有999999改为0,
因油机需要根据这个来判断是否为预置, 如果是预置则以后台为准;
2009-06-29 (1.06.2755)
[MOD]各油机模块变价处理时间间隔均调整为2s, 规避税控忙导致变价失败问题;
2009-06-29 (1.06.2754)
[FIX]稳牌模块GetPumpMsg返回值ret在正常读状态时未初始化, 先初始化为2;
[FIX]稳牌模块-ReSet在执行后状态未变的情况下, continue之前增加TX_NO++的处理;
[MOD]稳牌模块设置RCAP2L下限改为0x65,
初始执行一次GetPumpOnline再次判断是否已经有通讯;
[FIX]稳牌GetPumpStatus/GetPumpOnline/GetTransData这些返回数据长度一定大于3
的加强了结果判断,避免错误数据造成影响;
[MOD]稳牌模块GetPumpStatus修改返回值设置, 只有没有收到回复的情况才返回-1,
避免返回NAK的情况导致离线;
[MOD]稳牌模块DoPolling中模拟抬挂枪取消授权执行DoStop后判断结果再复位Log_Noz_State;
[MOD]稳牌命令间隔改为150ms;
[MOD]DoPolling中轮询改为使用GetPumpStatus而不是GetPumpMsg;
[MOD]lischn007-SetRCAP2L若失败恢复为默认设置值;
[FIX]稳牌所有命令函数增加对crc低半字节是否为fa的判断处理;
[MOD]lischn007-DoStop如果取返回信息失败那也也复位TX重试;
2009-06-15 (1.06.2753)
[MOD]完善恒山UDC模块, 移除tty.c中的测试代码;
2009-06-14 (1.06.2752)
[MOD]恒山UDC模块大部分功能OK, 还需要进一步做异常测试以及状态确认;
2009-06-10 (1.06.2751)
[MOD]Note! tty.c 中有测试代码;
[MOD]lischn.c 中有测试代码-- lischn019放到lischn002处调用;
2009-06-05 (1.06.2750)
[ADD]恒山UDC模块-lischn019(未连调, 未测试);
[FIX]稳牌模块抬枪处理中ReSet之后进行成功判断并且判断油枪是否已挂,
因为ReSet处理过程中可能已经挂枪, 如果已经挂枪则break;
[MOD]改进稳牌模块RCAP2L设置处理;
[MOD]修改稳牌模块NAK处理--收到NAK后一律复位TX重试;
2009-06-03 (1.06.2749)
[MOD]改进稳牌模块SetRCAP2L处理;
[FIX]修正长吉模块金额总累大十倍问题(油机返回的金额总累两位小数,
油量总来一位小数);
2009-06-02 (1.06.2748)
[MOD]稳牌SetRCAP2L所设置的RCAP2L由固定值0x75改为动态检测适用值;
2009-06-01 (1.06.2747)
长空卡机联动模块lischn018通过测试;
[FIX]稳牌ChangePrice在开始处增加了TX, 
但在 FP无需变价的情况下没有回退TX, TX不连续以致后续命令执行失败(比如变价);
2009-05-25 (1.06.2745)
[ADD]lischn018, 长空卡机联动模块(ZhuangHua)(未完整测试);
2009-05-23 (1.06.2744)
[FIX]修复节点交易量超过64条后再保存交易导致离线交易被清除;
[FIX]日志中离线交易条数显示错误(当前笔不算,比实际值少一笔);
2009-05-21 (1.06.2743)
[FIX]稳牌联线交易数据中枪号为零/抬挂枪不能取消预置;
[FIX]ReadFP_DATA中LNAR为固定值;
[FIX]WriteSV_DATA中M_st错误;
2009-05-20 (1.06.2742)
[MOD]ifsf_tcpip.c增加HBSendServ_STD/HBRecvServ_STD,
ifsf_main.c增加相应调用处理;
2009-05-19 (1.06.2741)
[MOD]宝德尔模块对dostop_flag的处理;
[MOD]宝德尔/正星/鸿洋模块打印状态日志处理从DoPolling移至GetPumpStatus;
[MOD]Hex2Bcd中拷贝字符串方式由sprintf改为snprintf, 防止溢出;
2009-05-18 (1.06.2740)
[MOD]修改libsrc-ipc-domsgq.c->MsgSnd和SendMsg的返回值处理,
根据不同情况返回不同的值,
并将errno反映到errno中(用于排查"SendDataToChannel失败的问题);
[***]lib需要更新
[MOD]宝德尔.老长空模块增加对 受控/自控 标记位的判断处理;
2009-05-13 (1.06.2739)
[MOD]ReadTTY,在发送数据给通道失败的情况不直接continue,而是清零ChnCmd之后再继续,
避免错误不能恢复;
2009-05-12 (1.06.2738)
[ADD]写当前运行ifsf_main版本信息到/var/run/ifsf_main.ver
[MOD]榕兴模块改为使用新版程序--与应中油要求修改后的油机程序对应(预置不再需要另外授权;取消预置同停止加油命令合并);
[MOD]宝德尔模块命令间隔由10ms改为100ms;
[MOD]修改老长空模块,完善校验处理, 修改日志信息, 修改脱机处理;
2009-05-08 (1.06.2737)
EndTr4Fp/ReadTR_FILEDATA中增加些交易明细到日志的操作(记录内容增加起始泵码和交易时间)便于对账;
移除各个油机模块中记录交易新日志信息的处理语句;
修改AddTR_DATA中MakeTrMsg和SendData2CD错误的返回值为1,
在此种情况下不允许重试执行AddTR_DATA, 否则会造成重复交易;
2009-05-05 (1.06.2736)
修正液位仪模块计算油净体积时的一个越界错误(vr350,tls2,lanhua_*, opw, rtl);
修正tank_pub.c-exp2floa中一个数据拷贝错误strncpy->memcpy(该错误在油位低的时候会导致上传数据错误);
2009-04-30 (1.06.2735)
日志转储检查时间由半小时改为10分钟;
2009-04-29 (1.06.2735)
backuplogfile改为使用mv代替cp+truncate的形式转储日志, 并直接写入Nand;
日志文件改为达20M转储一次;
移除掉电备份日志的处理;
长吉模块变价处理延长重试间隔, 保证达到2s;
正星模块变价处理在返回执行失败的情况下隔2s再重试;
修正ReadC_DATA中两个长度错误(0x12->0x0C);
2009-04-28 (1.06.2734)
log.c 修改backuplogfile,增加测试日志备份代码****
2009-04-27 (1.06.2734)
新长空模块修改通讯地址初始化处理, 解决油机地址不能设置为16的问题;
所有油机模块去除发送校罐数据的处理(统一由ChangeFpState和EndTr4Fp处理);
2009-04-24 (1.06.2733)
合并新的液位仪程序tank_vr350, tank_guihe, tank_opw_pv4(增加校罐);
新的液位仪校准处理方式;
2009-04-23 (1.06.2732)
所有模块初始化物理面号处增加对该条油枪配置是否启用的判断(避免节点号相同但是没有启用的配置影响正常配置);
长吉模块移除InitGunLog(一是不需要,
再是在PUMP_ID更改后处理可能会处理失败导致无法进行下去);
长吉模块InitPumpTotal增加延时处理--错开各个通道读取泵码的时间, 减轻IO板压力;
2009-04-22 (1.06.2731)
去除三金模块测试代码;
所有油机模块添加PriceChangeErrLog(CPPEI);
修改HandleStateErr-case Do_Ration, 限制为非Idle状态不能Do_Ration;
2009-04-14 (1.06.2729)
增加PriceChangeErrLog记录格式化变价错误日志到changeperr.log[按项目组要求]
2009-04-08 (1.06.2728)
鸿洋模块通过完整测试;
2009-04-07 (1.06.2727)
critical.log的存放路径改为使用参数配置WORK_DIR/etc/log.cfg->CRITICAL_LOG
2009-04-01 (1.06.2726)
三金模快有测试代码
所有油机模块变价函数中增加critical日志, 以及对ER_DATA 0x36, 0x37的处理;
2009-03-31 (1.06.2725)
添加变价错误日志记录(记录到critical.log),通用部分跟长吉模块;
2009-03-30 (1.06.2723)
长吉模块ChangePrice中加长发单价读取单价之间的时间间隔;
所有模块在油机恢复联线等待12s之后增加发送当前FP状态;
2009-03-24 (1.06.2722)
鸿洋模块基本完成
2009-03-19 (1.06.2720)
添加鸿洋模块lischn013(原正星6300模块改为lischn017.c)
2009-03-18 (1.06.2719)
长吉模块预置加油正常情况下增加两次重试,\
解决空闲下发预置量给油机有时候定不上的问题;
长吉模块DoStop增加重试机制;
取消抬枪后重发预置量的操作(因为不需要,长吉油机超时会自动取消授权,但是不会取消预置量);
2009-03-17 (1.06.2718)
长吉模块增加多次重发预置量的测试代码(测试证明有效果);
2009-03-11 (1.06.2717)
长吉模块做了若干修改--预置加油相关;
合并兰州石化的两个液位仪模块和爱国者液位仪模块;
2009-03-05 (1.06.2716)
恢复对心跳发送处理的修改(IP改为不同网段的时候能够探测到,
但是同网段时仍无法自动处理);
合并永盛修改的lischn001, lischn001主要是修改预置.授权相关处理;
合并永盛修改的lischn007, 针对稳牌6枪机做了一些调整修改.
2009-03-13 (1.06.2714)
宝德尔模块增加了命令头校验;
2009-03-10 (1.06.2713)
修正长吉模块预置加油因取枪号失败导致丢交易问题;
2009-03-04 (1.06.2712)
修正正星模块在交易刚完快速再次抬枪, 漏采Idle状态后该笔交易被清除的问题(移除
case FP_CALLING 开始处clr_offline_tr 的操作);
修正榕兴\三金等模块在通讯失败达两次时设置主控,导致GetPumpStatus的返回信息被覆盖,
以致DoBusy/DoEot等处理出错的问题;
2009-02-24 (1.06.2711)
修正SendFP_State中判断node有效性的一个bug(node > 127 --> node > 12);
2009-02-19 (1.06.2709) (1.06.2710)
修正恒山模块与油机通讯失败未到离线之前恢复联机, 没有重设主控的问题;
所有模块移除通讯失败重设串口属性的操作(避免ReadTTY接收数据时出现"非法数据");
暂时移除对心跳发送处理的修改(02-16 1.06.2706);
榕兴模块修正日志中的两个参数错误(i->pos and pos -> i);
修正正星6300模块在上位机离线情况下授权锁关也能加油的问题;
2009-02-18 (1.06.2708)
FIXED.修改油品换号处理--原处理将出售该油品的所有油枪均做了换号,
并会覆盖掉待换油品的油品配置;
2009-02-17 (1.06.2707)
修改宝德尔/中意模块的脱机处理;
修改宝德尔模块的日志/校验处理方式/面号处理方式;
2009-02-16 (1.06.2706)
修改心跳发送处理--若IP地址被修改,则重新设置广播地址和心跳数据包中的host_ip;
正星6300模块在预授权前增加是否达到未支付交易限制的判断;
正星6300模块收到Release_FP命令后直接回复ACK;
2009-02-13 (1.06.2705)
所有模块下发变价时记录变价命令到日志;
修正lischn006/lischn010两模块ChangePrice中的日志语句漏传参数问题;
完成正星6300模块并测试;
2009-02-12 (1.06.2704)
修正tty.c中REOPENTTY的一个bug--当fd为0时, maxFd没能+1, 导致接收数据失败;
正星6300模块基本完成(待完全测试)
2009-02-10 (1.06.2703)
增加lischn013 for 正星6300
2009-02-10 (1.06.2702)
修正RunLog中时间戳月份少1的问题(tm->tm_mon: 0-11);
2009-02-09 (1.06.2701)
修正中意模块pump.panelPhy[]索引错误;
修正ReadFP_DATA中原地址与目的地址固定的问题;
长吉模块修改初始化处理, 增加支持 PUMP ID == 16;
2009-01-16 (1.06.2635) 准更新版本 (-->1.06.2700更新版本)
修正太空模块DoAuth中参数传递错误问题(pos -> i)
2009-01-15 (1.06.2635) 准更新版本
修正lischn002.c中一个因测试留下的bug--上线后没有设置主控就直接break;
三金模块lischn012.c 增加对11状态的处理(加油量达到最大值后挂枪是11而不是00)
2009-01-08 (1.06.2634) 准更新版本
修正稳牌Closed状态时, 如果油机状态是5不能变价的问题;
2009-01-07 (1.06.2633) 准更新版本
修正lischn004.c DoEot中打印信息的一个小bug (i+1 -> pos + 1)
lischn015.c GetPumpStatus中增加对油机当前控制模式的判断, 如果监控则设置为主控
修改 tank_vr350.c/ tank_tls2.c /tank_opw.c
移除根据油罐禁用情况改变TP_Status为1的操作
(避免因禁用罐导致Fuel读取油罐数据不全的问题--Fuel不改,只有暂时适应之)
2009-01-04 (1.06.2632) 准更新版本
-+-------
-+ 回滚榕兴模块和稳牌模块, 分别改为基于1.06.2600-spec4和2619的版本, 增加以下修改:
-+ 1.Close/Inoperative状态下增加变价支持;
-+ 2.修正榕兴变价失败情况下的一个bug;
-+ 3.DoCmd/DoPolling 由 {if DoCmd else DoPolling} 关系改为 {if {DoCmd}; DoPolling};
-+ (当前版本重命名为_newpump.c后缀的文件)
-+ 回滚原因: 需要应用近期修改整理一个升级版本, 但是现场榕兴油机可能未完成改造,
-+ 所以近期与油机改动相关的程序改动暂时不能应用; 稳牌模块因为6枪机未调试完成,
-+ 暂时不能使用新版本;
-+--------

移除RunLog中的printf操作(已无作用), 节约资源占用;

2008-12-30 (1.06.2631)
增加一个新函数SendFP_State, 用于发送当前FP状态,
具体原因参看ifsf_dspfp.c-SendFP_State;
稳牌模块做了一些修改, 未稳定;
2008-12-29 (1.06.2630)
为避免因意外电压不稳导致单片机复位造成串口属性设置恢复初始值,
导致不重启无法恢复通讯的问题, 做了以下3点修改:
1.判定离线之前也增加重设串口属性的操作,
2.[长吉]模块增加ReDoSetPortxxx(), 用于在油机离线的情况下间歇性重新设置串口属性;
3.SetPortxxx()中移除对ChnLogSet是否已经置位的判断--只要调用SetPort则无条件重设串口属性;
长吉\三金\正星模块已做相应修改(并测试通过);
榕兴模块和恒山自助模块不修改(本身是9600,8,n,1);
其他模块均做修改, 但未测试;

使用新的Vrcomm库, 解决打开串口失败的问题;
2008-12-23 (1.06.2627)
修正恒山\榕兴模块变价失败改变FP状态为Inoperative之后直接return 的问题;
2008-12-21 (1.06.2626)
合并博士所作修改(串口计算相关:MAX_PORT_CNT & GetSerialPort())
2008-12-19 (1.06.2625)
移除长吉模块case PUMP_ERROR的处理--不再根据油机状态改变FP状态为Inoperative;
2008-12-18 (1.06.2624)
移除正星模块case FP_INOPERATIVE的处理;
正星模块变价正确的情况也增加读取单价进行确认的操作;
修正正星模块GetPrice中校验计算错误的bug;

2008-12-17 (1.06.2623)
修改HandleStateErr, 在写错误数据库之前先回复NAK;
修改WriteFP_DATA, 完善处理--不管对FP的操作成功与否, 除了要返回ACK/NAK,
还要返回当前FP_State;
修改稳牌模块,增加TX#的处理(未调试好);

2008-12-16 (1.06.2622)
掉电处理虽然不再推出程序, 但是保留备份日志的操作;
奥科模块对返回数据增加长度判断;
2008-12-11 (1.06.2621)
全部模块增加对Closed/Inoperative状态执行变价的支持;
全部模块在初始判断油机是否在线时,若油机不在线,则轮询间隔不断加长的处理改为固定轮询间隔为1s;
油机处理模块主题循环处不管是否有命令需要执行,
之后都进行轮询(原来是DoCmd之后开始新的循环);
油机脱机回复连接上线后延迟12s在进入正常流程, 确保Fuel已经收到心跳;
若油枪油品配置为空则循环检测, 而不是退出, 保证串口能够登录;
太空模块修改校验判断方式;
修正ifsf_tcpip.c TcpRecvServ中recvSockfd[i]的i没有初始化的问题;
恒山模块停止加油/取消预置//预置均改回使用原有指令(同2600);
恒山模块设置主控的处理仍做保留;

2008-11-27 (1.06.2619)
修正豪升模块初始化pump.addInf时索引错误导致数组越界的bug;
2008-11-20 (1.06.2618)
修改__RunLog, 时间戳增加毫秒
2008-11-19 (1.06.2617)
修改正星模块GetTRansData的处理方式(未测试);
2008-11-18 (1.06.2616)
修改稳牌模块, DoPolling中case
FP_EOT增加调用ChangePrice的操作---解决下发变价之后需要抬挂枪才能变价的问题;
2008-11-17 (1.06.2615)
修改恒山模块预置加油处理---改为使用AD/AE命令;
不再使用SetCtrlMode设置主控(控制模式切换通过键盘操作);
修改power.c , 掉电只记录不处理;
2008-11-15 (1.06.2614)
修正ifsf_main中进程计数少一个的问题;
2008-11-14 (1.06.2614)
修改恒山模块,
停止加油和取消预置改为使用0xB0;并修改部分与PUMP_LOCK状态相关处理;
2008-11-13 (1.06.2613)
修改upload_offline_tr, 如果读脱机交易时有未完成的脱机交易, 则回复NAK--device
busy;
2008-11-12 (1.06.2612)
ReadPR_DATA增加对读取油品名称的支持(Prod_Description);
修正ReadPR_DATA中的一个bug--内层循环使用了外层循环的循环变量;
init.c 中增加初始化配置文件中的油品名称到数据库中(Description);
修改恒山模块, 增加脱机处理;
2008-11-11 (1.06.2611)
修正三盈模块注释掉主控处理之后的一个bug(无法上线);
2008-11-10 (1.06.2610)
增加油品换号相关处理(基本测试通过)
2008-11-07 (1.06.2609)
修正稳牌模块已授权状态断电脱机恢复之后第一次预置加油失败的问题;
修正稳牌模块脱机恢复有可能读泵码失败的问题;
2008-11-06 (1.06.2609)
修正稳牌模块因11.31调整总清操作到抬枪后导致预置定不住的问题;
修改正星模块, 完善读取交易后清除交易不成功的处理;
2008-11-03 (1.06.2608)
因榕兴油机程序(协议)有所修改, 所以榕兴处理模块也做相应修改:
取消预置授权改为使用停止加油命令DoStop; 预置不再需要另外授权;
完成榕兴模块油机脱机修改;
2008-10-31 (1.06.2607)
修改稳牌模块交易结束立即总清的问题(会导致加油员看不到当次交易);
2008-10-30 (1.06.2606)
修改豪升模块取消预授权的处理--通过抬挂枪可以取消预授权(Authorised->Idle);
2008-10-29 (1.06.2605)
按照10.29日定论的脱机处理方案修改新长空模块;
(FCC不对脱机交易进行任何处理, 连上时若正在加油,则按正常交易处理,
由Fuel将其处理为脱机交易)
2008-10-27 (1.06.2604)
修正恒山自助加油机模块初始化泵码函数中泵码错位问题;
2008-10-24 (1.06.2603)
修改恒山自助加油机部分实现(主要是帧号和交易序列号的计算);
2008-10-23 (1.06.2602)
三盈模块修改取消预置授权的取消处理(与停止加油命令统一);
三盈模块停止加油命令返回数据增加一字节表示是否成功;
2008-10-22 (1.06.2600)
2008-10-21 (1.06.2526)
修改掉电处理部分对掉电信号的判断处理--每隔400ms追加两次检测,
三次掉电信号确认为真正掉电;
2008-10-18 (1.06.2524)
添加恒山自助模块(未完);
2008-10-17 (1.06.2523)
修改太空模块GetPumpStatus的失败重试次数为2;
2008-10-16 (1.06.2522)
修改榕兴模块的DoEot处理, 对交易金额也增加类似交易油量的处理--判断第三位小数,
进行四舍五入;
2008-10-15 (1.06.2521)
修改模块GetPumpStatus变长处理, spec.c中的addInf[]由0x02改为0x03;
太空模块SetCtrlMode增加对返回数据的校验, 修改GetPumpStatus的校验判断方式;
太空模块DoEot中获取单价的操作提至DoEot开始,因为读完交易后马上就读状态第一次总是失败;
太空模块DoPolling中GetPumpSTatus成功后先判断当前状态是否为主控(status&0x04),
如果否,则设置主控.
2008-10-13 (1.06.2520)
修正稳牌模块定量加油无效的问题(因为添加了 SetNozMask)
2008-10-09 (1.06.2518)
增加了tank_tls2.c VR协议处理模块, 适用非校罐液位仪,
不使用VR提供的库函数.解决有时候重启FCC连不上液位仪的问题.
修改太空模块油机脱机处理(TopHalf), 一旦判定油机离线,
那么离线时间一定要够30s才能重新上线, 确保Fuel知道油机离线过;
2008-10-07 (1.06.2517)
稳牌模块修改 DoCmd 中DoAuth成功的处理(原为与正星模块复制,
改为与没有started状态的油机模块一致);
修改豪升模块取消预置的实现,由下发0L改为下发999999元,
油机方面修改程序支持停止加油命令取消预置, 所以最终改为使用 DoStop;
2008-09-27 (1.06.2515)
修改三盈脱机处理;
修改三盈模块DoEot/DoEot_Additional中日志打印交易数据语句的一个错误,
pump.gunLog未加索引(pump.gunLog[pos]);
2008-09-26 (1.06.2515)
ifsf_dspfp.c 499行对二配相关处理作了一点修改;
对三盈模块油机脱机处理做了一点修改.
更新了dla_main.c;
2008-09-25 (1.06.2514)
完成对三盈模块油机脱机处理的修改, 待测;
2008-09-24 (1.06.2514)
添加新中意模块(2.0协议) 完成主体功能的处理和测试;
2008-09-23 (1.06.2513)
修正三盈模块CancelAuth返回数据长度少一个字节的问题, 增加对返回数据的校验;
2008-09-22 (1.06.2513)
修正正星模块DoEot[_Additional]中在泵码没有变化的情况下没有执行GetTransDat导致零交易不能清除的问题;
修正正星模块初始化泵码处Hex2Bcd后total[2]被清零的bug;
应二配问题更新dla_main.c, ifsf_dspfp.c, ifsf_main.c
2008-09-19 (1.06.2512)
更新dla_main.c
2512-...->2500
2008-09-18 (1.06.2512)
整理9.20部署版本...
lischn003.c 修改 DoPolling ,case PUMP_OFF: 如果FP状态为Authorised,
那么也做交易;
2008-09-17 (1.06.2510)
正星模块DoEot取泵码改为使用GetPumpTotal而不是直接从交易数据中得到;
2008-09-16 (1.06.2510)
修改榕兴和稳牌两个模块的油机脱机交易处理, 未测试;
修复DoEot_Additional中的一个bug, DoEot_Incomplete 之后增加 EO_OFFLINE_TR;
2008-09-12 (1.06.2509)
lrc.c Check_xor 和 CRC_16 的参数len改为有符号型;
完成豪升模块的油机脱机处理测试;
2008-09-11 (1.06.2508)
恒山模块油机脱机处理修改测试完成;
修改DoPumpComesBack_BottomHalf, 移除按面循环的处理,因为该函数本身只处理一个面;
修改DoEot_Additional, 在判断总累之前如果读取交易或者泵码失败,
那么直接做DoEot_Incomplete;
2008-09-10 (1.06.2507)
三盈模块在启动上线之前增加检查当前状态的操作,
如果不是空闲或者抬枪状态则一直等待;
2008-09-09 (1.06.2506)
修正太空ChangePrice中RunLog参数缺失的bug;
长吉模块增加GetGunPrice用于获取单价和确认变价是否成功;
长吉模块修改ChangePrice变价命令的间隔为150ms;
完成正星模块的油机脱机处理;
2008-09-05 (1.06.2503)
修正长吉模块DoRation中lnz_allowed初始值错误, 下发的枪号应该从0开始;
修正ifsf_dspfp.c WriteFP_DATA中给Log_Noz_Mask赋值错误的问题,
Log_Noz_Mask=recvBuffer[12+i] 而不是 recvBuffer[13+i];
三盈模块完成油机离线脱机的处理;
2008-09-04 (1.06.2502)
三盈模块修改对油机离线的处理;
二配处理initCss中增加对创建和打开管道失败的重试处理;
2008-09-01 (1.06.2500)(9.1版本)
优化了掉电处理程序;
三盈模块增加对回复数据的校验处理;
2008-08-29 (1.06.2416)
修改长空/三盈/太空/宝德尔, 去除不必要的变量, 修改DoEot部分处理, 增加重试,
修改三盈模块变价重试处理;
修正长吉/豪升/正星模块变价处理中调用RunLog时的一个bug(参数个数与描述符个数不相等);
长吉/稳牌模块增加对Log_Noz_Mask的支持处理(针对单面多枪的情况, 只涉及DoRation,
Log_Noz_Mask的恢复--允许全部油枪由Fuel处理);
2008-08-28 (1.06.2415)
合并二配相关的处理, 设置修改的文件: ifsf_dspfp.c, ifsf_main.c, ifsf_pub.h
处理代码(除了定义)都加了编译条件(#if SECOND_DISTRIBUTION ... #endif);
2008-08-27 (1.06.2413)
更新液位仪处理程序, 调整液位仪模块在配置界面上的顺序, 并移除 tank_frkl.c
(使用tank_opw.c);
2008-08-21 (1.06.2412)
除了榕兴和中意模块, 所有模块增加DoEot_Additional,
处理加油中油机离线情况, 将不完整实时数据形成脱机交易上传;
修正模拟加油机模块中的两个bug;
佳力佳模块修改了物理面板号减一的处理方式-- pump初始化的时候减一,
而不是使用的时候;
lischn003, ifsf_main.c 删除若干冗余变量;
2008-08-20 (1.06.2411)
完善稳牌模块, 增加对校验中有字节为0xFA情况的处理;
豪升模块增加对豪升开机时错误状态的忽略处理;
2008-08-19 (1.06.2410)
更新太空模块;
修正豪升模块测试未通过项;
2008-08-18 (1.06.2409)
完善稳牌模块对于通讯地址.泵码的处理(同样的取泵码命令因油机类型不同返回的泵码数据格式会不同);
三金/稳牌/富仁豪升三个模块的CRC校验同改为查表计算;
2008-08-18 (1.06.2409)
ifsf_dspfp.c - HandStateErr 中增加处理: 如果当前状态不允许执行改操作,
那么除了返回NAK, 还主动上传当前FP状态(按IFSF);
2008-08-17 (1.06.2408)
修正tank_vr350.c 中关于温度负值的一个问题;
修正稳模块几个bug;
修正长吉模块抬枪执行Terminate_FP不成功的bug;
2008-08-16 (1.06.2408)
完成稳模块;
所有模块 DoPolling 中油机离线/恢复处理部分,
循环各个面处理改变FP状态等操作时, 如果执行失败,
进行的操作由continue改为return;
稳模块ChengePrice 完成变价操作后要清零整个newPrice, 整个, 不同于其他模块;
完善长吉模块在抬枪和已授权两种状态下执行DoStop后的处理;
按照IFSF协议, 在XXX_FP执行失败的情况下要上传原始FP状态, 长吉模块增加次处理,
其他模块未修改!!;
2008-08-14 (1.06.2406)
添加稳牌模块, 基本完成, 差变价
2008-08-11 (1.06.2400)
完成佳力佳模块的调试和测试;
恒山模块完善对后台小量预置导致油机锁机的处理;
2008-08-05 (1.06.2305)
基本完成佳力佳模块lischn015, 待测试完善
2008-08-02 (1.06.2302)
完成lischn011
更新lischn003.c/lischn006;
修正现有模块在已授权状态下发变价失败的问题,
增加判断在所有FP状态均为Idle时才执行ChangePrice;
2008-07-31 (1.06.2300)
修正重启日志检测进程时启动掉电处理程序的错误;
根据内核版本号进行掉电处理程序的选择启动;
根据内核版本情况选择启动屯缱刺觳饨?
2008-07-31 (1.06.2300)
将掉电检测放到主进程中处理, 而将日志检测和备份改为用子进程处理;
2008-07-30 (1.06.2204)
完成豪升模块;
2008-07-29 (1.06.2203)
增加网络状态检测; (nic_monitor.c)
修改掉电标记检测为netlink方式;
2008-07-28 (1.06.2202)
加入了永盛改好的lischn003.c
豪升模块基本完成;
lischn001,002,005,009 4个模块DoCmd,DoRation 返回后不管正确与否都清零Remote_*_Pre*
正星模块DoPolling.IDLE, 在fp_state为零的情况下, 如果油机中有交易, 则将其清除
UpdateOilCfg中fgetpos/fsetpos 改为用 ftell 和 fseek 
2008-07-23 (1.06.2201)
setcfg.c增加UpdateOilCfg用于变价后更新油品配置文件(由WriteFM_DATA调用)
2008-07-18 (1.06.2200)
更新lischn032.c, 修正若干问题;
2008-07-17 (1.06.2107)
TcpSend2CDServ进程初始化的时候增加判断gpIfsf_shm->recvSockfd[x]是否为零,
如果非零, 则关闭该socket, 并将其置零;
TcpSend2CDServ中不再创建连接, 连接建立方式改为连接有问题时关闭连接,
有数据要发送的时候才建立连接, 不再实现建立连接;
修正SendData2CD2中gpIfsf_shm->auth_flag=DEFALUT_AUTH_MODE的错误操作;
修正SendData2CD2错误重试没达到4次的bug;
修改"FCC上传:..."提示的位置, 等完成实际发送才提示;
WriteTR_DATA中对找不到交易的情况增加NAK回复;
ifsf_dsptr.c 2947 OffLineSetBuff中增加设置fp_offline_flag的操作;
ifsf_tcpip:c 在CD恢复联线的时候增加"上位机恢复联线"的提示;
修改TransRecvAllTR_DATA 中DB_Ad 的TR_DAT部分, 由0x20改为0x21;
ifsf_tcpip.c:298  如果Fuel重连FCC, FCC也重连Fuel (不太妥当,
但目前没有很有效的方法知道连接出了问题, 暂行此法);
2008-07-14 (1.06.2102)
修正模拟加油机模块DoEot中memcpy数据错位问题
2008-07-14 (1.06.2102)
修改恒山、正星、太空、榕兴、三金、模拟加油机几个模块,增加新的脱机交易处理;
修改xx_OFFLINE_TR宏的定义;
修正ifsf_dsp.c
中关于读取某FP全部未支付交易处理中的一个bug--只能处理FP_ID==21的情况;
2008-07-11 (1.06.2100)
修改脱机交易的处理方式--交由油机模块读写上传,
脱机交易处理函数放置到ifsf_dsptr.c;
ifsf_dsp.c 中原处理函数TransrecvTR_FILEDATA仅做消息转发的工作;
lischn001/lischn011增加对新的脱机交易处理的支持(修改的地方有DoCall,DoPoll,
DoCmd);
修改脱机交易信息中token的计算方式, 解决原脱机交易上传不全的问题;
ifsf_dspfp.c
中ChangeFP_Run_Trans增加对联机后未完成的脱机交易的处理--不发送实时加油信息;
ifsf_dsptr.c AddTR_DATA中在交易为脱机交易的情况下也不上传主动交易信息;
ifsf_pub.h  共享内存 Ifsf_shm
增加fp_offline_flag[][]用与标记是否有脱机交易和是否有未完成的脱机交易;
移除原心跳接收模块中离线回复时WriteBufDataToFile的操作;
HBSend修改仅在上位机在线的情况才发送心跳的设置,改为任何时候只要设备正常就发送心跳;

增加lischn032.c 模拟加油机模块
2008-07-09 (1.06.1909)
证明正星模块取道数据错误问题与程序无关, 可能与硬件有关,
所以将命令间隔改回100ms;
2008-07-07 (1.06.1908)
三个模块改进DoPolling 中油机离线恢复后的处理,
增加的处理为恢复处理过程中任何一步出错都置fail_cnt为1, 然后重新轮询;
ifsf_main 的版本号改为使用宏定义 PCD_VER, PCD_VERSION;
正星模块将命令间隔调整为200ms, 测试现场加油点错误的问题
2008-07-05 (1.06.1906)
修正正星模块DoEot.中err_cnt++ 后又err_cnt=0 的问题
2008-06-27 (1.06.1905)
修正正星模块DoEot.GetTransData时err_cnt未自增的问题;
power.c中掉电处理增加对掉电信号的确认, 增加容错性,防止干扰
使用原tank_vr350.c, 不带禁用罐处理, 仅增加对探棒禁用并且断开的状态处理
2008-06-26 (1.06.1901)
修正恒山模块DoPolling.case PUMP_BUSY: 交替转换状态为 Started 和 Fuelling
的问题;
修正恒山模块停止加油成功状态转换为IDLE后又转换为Fuelling的问题.
2008-06-25 (1.06.19-alpha)
删除恒山模块DoBusy中冗余处理;
case PUMP_BUSY: 将DoBusy提至Change FP State to Fuelling 之前,
尽可能加快对Fuelling 状态的反映速度;
正星模块变价失败增加重试;
修正长吉模块DoAuth中GetPumpStatus调用是参数pos错误的问题(pos->i);
三个模块均将初始化Current_Tr_Seq_Nb, Current_Prod_Nb, Current_Unit_Price,
Log_Noz_State的操作提取出来放入 DoStarted函数, 并在 case PUMP_CALL:
DoCall之后就调用, 在DoAuth末尾, case PUMP_Started, case
PUMP_Fuelling进行检查确认(若未设置成功, 则重设), 确保设置成功;
fp_state[] == 2 表示 DoStarted 执行成功, 即相关数据项设置成功;
case PUMP_IDLE: 判断如果fp_state[] >= 2, 则进行交易处理,
是否有交易以及交易是否为零由DoEot判断, 毕竟抬空枪的情况占极少数,
由此最大限度保证不因漏采状态而丢交易.
2008-06-24 (1.06.19-alpha)
修改ChangeTpStatAlarm在TLG 不在线的情况下不发送主动消息;
移除恒山模块对挂枪状态的确认处理;
调整tank_vr350.c从CheckTPCfg的调用位置, 增加命令间隔,
尝试解决i601命令有时候返回数据为i201数据的情况;
恒山模块变价失败增加重试;
2008-06-23 (1.06.18)
移除恒山模块交易结束后挂枪状态的再次确认, 增加处理速度;
恒山模块ChangePrice 若失败则重试 (失败或者相同单价不计变价次数);
改进 tank_vr350.c 中CheckTPCfg的处理(修改命令间隔, 调整调用位置)
2008-06-23 (1.06.18) ***
修正CheckTPCfg 申请内存未释放问题
2008-06-22 (1.06.18)
CheckTPCfg的数据缓冲区重新改回malloc分配;
恒山正星长吉三个模块DoEot中移除取信息失败直接返回的处理, 增加重试次数,
最大限度确保交易能够生成上传;
移除恒山模块DoEot中的GetPumpStatus, 冗余操作;
临时性把判断加出了油才将fp_state置为2的操作移除;
长吉模块case PUMP_ERROR计数超过5次才改变FP状态为Inoperative;
恒山模块状态轮询失败超两次将重新设置主控模式,
但是如果当时正在加油则不进行该处理, 以免影响FP状态转换和Rollingupdate,
等到空闲后再设置;
2008-06-21 (1.06.16)
修改tank_vr350.c CheckTPCfg 中的数据缓冲区为数组(原为malloc)
2008-06-20 (1.06.16)
恒山模块INTERVAL改为250ms;
GetPumpStatus重试次数改为2次;
恒山模块DoPolling, fail_cnt >= 2, 并且油机在线的情况下增加设置主控模式的操作;
只有在FP状态小于Calling的情况下, case PUMP_CALL 才做DoCall;
恒山模块在授权后判断状态是否变为ex, 如果是则置位标记pump_lock_flag, case
IDLE的时候进行CancelCtrlMode &
SetCtrlMode的操作,以解除锁定状态授权下次有效的情况.

2008-06-19 (1.06.16)
lischn002.c INTERVAL改为 300ms
2008-06-18 (1.06.16)
tank_vr350.c 增加读取液位仪油罐配置情况的处理,根据配置情况改变TP_Status,
以解决TP禁用后仍有数据仍然operative的问题
2008-06-17 (1.06.15)
tank_vr350.c 增加对探棒号不连续情况的处理?TP:1/2/4/5),
TP3的状态应为Inoperative, 连上后恢复为operative.
2008-06-16 (1.06.15)
3个模块均修改为状态变化才打印当前状态字
MAX_FAIL_CNT 改为5
DoPolling->GetPumpStatus之后, 判断如果正常增加fail_cnt = 0
2008-06-13 (1.06.13)
修正恒山校验处理判断的一个bug(0xFF=>0xEE)
修正恒山变价处理中的一个小bug
2008-06-11 (1.06.13)
恒山模块对返回数据进行校验确认
恒山模块增加对加油结束未挂枪状态的处理(忽略)
DoBusy改为使用DoPolling轮询得到的数据而不是函数内部再次读取
2008-06-10 (1.06.13)
修正恒山模块在转变为Fuelling状态之前发送Running_Msg的问题
改善日志显示
恒山模块增加对返回信息的错误判断(遇到取道的状态信息前4个字节最后才接收到的问题)
2008-06-10 (1.06.12)
修正恒山模块变价未确定是否成功就更新油品数据库的单价的问题
去除TransRecvAllTR_DATA中WriteTR_DATA的操作(交易数据库写操作没有针对整个Node的)
修正模块初始化时newPrice数组初始化错误问题
恒山模块DoPolling中增加对加油结束未挂枪状态的处理(忽略这种情况下的抬枪状态)
2008-06-09 (1.06.12-beta)
修正DelClearTR_DATA中tmp_fp_tr_data[] 没有初始化的问题
2008-06-08 (1.06.12-beta)
移除DoPolling中在FP为Closed的状态下不断主动发状态消息的处理(应用到长吉/正星/恒山三个模块)
2008-06-07 (1.06.12-beta)
upgrade tank_aoke.c tank_opw.c tank_vr350.c
tank_aoke_tb.c,修复油温读数方面的另一个问题;
增加日志备份(包括掉电时) 和 定期删除日志处理(由脚本和crond实现)
2008-06-06 (1.06.12-beta)
修正读取全部未支付或者锁定交易处理部分的bug--数据项对应错误;
修正tlgtp中油温处理部分的一个小bug
2008-06-04 (1.06.11-beta)
长吉正星恒山三个模块在油机离线改变FP状态为Inoperative之前增加改变状态为Closed的操作;
脱机重连后上位机来读脱机交易, \
如果无脱机交易则回复ACK0,如果有交易,则读到没有交易后不再发送没有脱机交易的ACK0报文,
修改ReadTR_FILEDATA的返回值实现, 无脱机交易返回1;
脱机交易也增加对起止泵码的支持 ReadTR_FILDDATA 中增加 case TR_Start_Total,
TR_End_Total
2008-06-04 (1.06.11-beta)
修正液位仪油温数据格式(Long_Temp -> Temp)
2008-06-03 (1.06.11-beta)
修正长吉多枪机情况下, 油机离线恢复连线后只有一个FP回复为Closed的问题;
修正DoEot中数组索引FP号错误的问题, pos 错写为 i
2008-05-30 (1.06.11-alpha)
DoEot.SendMsg 传给液位仪的泵码和油量格式改为压缩BCD;
修正正星模块交易数据中终止泵码为金额总累的问题(终止泵码全部改为用Log_Noz_Total赋值)
2008-05-30 (1.06.10-alpha)
长吉、正星、恒山三个模块增加油机脱机重连后更新当前泵码的处理;
正星模块增加油机脱机重连后清除脱机交易的操作;
三个模块都增加向VR液位仪发送加油数据的操作;
更换libvrcomm.a
2008-05-29 (1.06.10-alpha)
修正长吉模块中初始化油枪泵码和当前油价错误的问题(多枪机) ;
2008-05-28 (1.06.10)
修改长吉模块对预置加油的处理,适应多枪机; 
2008-05-28 (1.06.09, Release)
VR350R增加校罐功能, 恒山模块增加校罐操作 ;
修改长吉模块交易截止泵码为金额总累的问题 ;
修正ifsf_dspfp.c中从固定位置读取预置量的bug(recvBuff[12])
2008-05-23 (1.06.09-alpha)
修改日志格式 ;
修改长吉定额加油命令为6位模式
2008-05-22 (1.06.09-alpha)
增加两个Data_Id 到TR Database, 分别是 TR_Start_Total, TR_End_Total ;
EndTr4Fp 增加两个参数 start_total, end_total ;
注释掉全部模块的油机脱机情况下的脱机交易处理 ;
移除EndTr4LN 的参数 amount, volume, price, 不需要 ;
恒山变价操作失败后读取单价确认之前先延时1s ;
恒山增加E0状态的处理 ;
去除若干不必要的日志

2008-05-21 (1.06.08)
修正脱机交易上传不全的问题 ;
修改奥科探棒状态不能转换为Operative的问题
2008-05-20 (1.06.08)
修正脱机交易处理程序内存问题
2008-05-19 (1.06.07-t)
增加永盛所做修正 ;
恒山模块增加根据泵码差补传脱机交易的处理 ;
修正恒山模块油机脱机后未设置主控模式的bug ;
缓冲区中脱机交易超过200笔,则转储到文件中 ;
增加对TP离在线的单独处理 ;
恒山模块增加对变价失败的确认处理

2008-05-14 (1.06.07)
更新恒山模块, 增加了油机脱机处理
奥科模块增加对探棒设备故障的处理
2008-05-12 (1.06.07)
修正长吉模块ChangePrice中newPrice的索引问题, 误将pr_no写成i
完善长空、三盈、榕兴模块在抬枪情况下DoRation的处理
2008-05-10 (1.06.06)
修正ZX/CJ/HS/三个模块DoRation失败没有清零Remote_Volume_Preset &
Remote_Amount_Prepay 的问题
2008-05-09 (1.06.05)
修正只能加一笔油, FS不做Clear TR的问题
2008-05-07
fix Zhengxing Trans_Seq_Nb problem
2008-05-06
完成读取全部未支付和锁定交易的操作
修复上传的FP状态信息长度为E0的情况
2008-05-03
将交易序列号的加以操作放到EndTr4Fp中处理, 修改Cancel的实现并更名为EndZeroTr4Fp
修改TCP Server的实现, 解决连接问题
2008-05-01
修正lischn001.c 为加油而进入Fuelling的情况
2008-04-30
tank_list[0]改为VR350不带校罐
添加永盛修改好的澳科模块
2008-04-28
修改了澳科模块
2008-04-22
更改DoPolling中fp_state为数组, 适应多面油机
修正getlocaltime函数的实现(获的的是本地时间而不是UTC时间)
TCP接收进程增加更好的容错性

2008-04-21
修正DoPolling 中离线/恢复联线处理
修正初始化第二油品单价的问题
SENDSTATE改为5
MAX_PORT_CMDLEN 从 16 改为 255
规避正星 STARTED->IDLE 有零交易的情况

2008-04-18  (version:1.05.04)
fix lischn005.c (zero TR)
VR350 OK

2008-04-08
修正一下小bug, eg. DoEot中fp_ln_data的索引, fp_m_data 的索引等

2008-04-06
新配置修改测试成功
CancelTr4Fp添加测试成功
Running_Transaction_Message_Frequency 添加测试成功
修复lischn001.c 中几个bug
修复液位仪离线但是仍然有心跳的问题

2008-03-30
修正完善ChangeFP_State/ChangeTR_State/ChangeER_DATA等操作的ACK first问题
CD脱机再联机后主动上传当前pump和TLG的状态信息

2008-03-27
增加脱机交易处理，并联调通过

2008-03-20
完成联调测试的版本

# ------------ End of changelog.txt ------------- #

commit 6a423c3d912bb01ff8f06df126945908f33e8b49
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Mar 7 11:12:12 2012 +0800

    --FIX   修正校罐采集数据写入时加锁粒度设置错误导致数据写窜的问题

commit 23facd7e880199356b1af0c2a335d7e7f0c94301
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Nov 9 15:18:08 2011 +0800

    --ADD   校罐数据采集,添加记录加油机和液位仪离在线变化

commit 3b9d568f71925c2ee21770cbec3c43a7d01fb830
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 15 15:42:10 2011 +0800

    --FIX   校罐数据采集,修正数据写入和文件转储互斥漏洞导致数据写丢的问题
    
    	1.在数据写入进程打开文件之后写入数据之前,文件转储进程转移了文件,
    	导致数据写丢.
    	2.写开始加油记录的时候增加状态判断,确保同一笔交易55记录唯一

commit 0753c543aa2b8b912e1f8d11acad5d849eec785e
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Tue Jun 7 13:34:02 2011 +0800

    --MOD   校罐数据采集,补充实现所有液位仪模块整厘米上下1mm记录详细液位功能
    
    	1. 维德路特、博瑞特、OPW SS1之外的液位仪模块也增加整厘米上下
    	   1mm内液位差大于等于0.01mm就记录液位的功能

commit ccc53972b0daf76c69eb99aeb32d41411ac68a77
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Tue Jun 7 13:20:50 2011 +0800

    --MOD   校罐数据采集,停止后重新开始采集或者重启了程序后记录零液位作为标记
    
    	1. 按罐记录零液位记录,仅液位高度为0即可

commit fcb638ea77fe4524b5aa64ad866588f07d3b9eee
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Tue Jun 7 11:12:42 2011 +0800

    --MOD   校罐项目处理,数据文件备份大小改为可配置,范围10K-5M
    
    	1.配置项: /home/App/ifsf/etc/pub, TCC_AD_FILE_SIZE,
    	  取值10-5000,超出范围默认设定200

commit 035ac28cf777482f1e68123050ba790c73244332
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Sun Jun 5 09:43:00 2011 +0800

    --MOD   校罐数据采集--接近整厘米液位时详细记录0.01mm的液位变化(仅tls2)
    
    	1. 如果液位高度在整10mm高度上下1mm处,当差值>=0.01mm就记录液位
    	2. 否则,差值>=0.1mm记录液位
    	3. 数据文件2M备份一个

commit 6509b058e213fdc49c3964b54d5596cdd7b586dd
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Sun Jun 5 09:36:17 2011 +0800

    --MOD   校罐数据采集--液位数据采集的液位变化差改为0.01mm,临时使用
    
    	只要液位数据变化达到0.01mm就记录液位,用于详细收集原始数据

commit afb90ab46f4201dbe6932b90dc93e5cec0135dd4
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Fri Jun 3 11:10:02 2011 +0800

    --MOD   校罐项目数据采集--改善因通讯问题导致交易结束不记录液位的情况

commit 45194bd8a2c7f40d35a40d8e5f7146ec3e1bf3bb
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Thu Jun 2 12:20:46 2011 +0800

    --MOD   校罐项目数据采集--改为记录所有实时加油数据

commit ec543b7fb659c1a62f066a6bb9b69964507acd6a
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Thu Jun 2 11:38:15 2011 +0800

    --FIX   校罐数据采集--修正最后一笔实时数据总是跟交易量一致的问题.

commit 853997474fc2b317a9699ddc2a61709e5c4320b8
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Thu Jun 2 11:17:18 2011 +0800

    --MOD   校罐数据采集--数据文件转储增加锁操作避免产生不完整记录

commit e03e76275631e7657ec5d9d47801724cb112c2ca
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 1 18:53:28 2011 +0800

    --MOD 校罐数据采集增加功能--有交易结束不管液位差是否足够也记录液位
    
    	1. 记录液位的高度变化差由1mm改为0.5mm
    	2. 转储数据文件的大小改为50k，tcc_adjust.csv达50k就转储
    	3. 一旦有交易结束，不管液位变化差是否达到0.5mm也记录当前液位

commit bc1bf342c1b3b7f8b7c8191689a7bf2985fa2cab
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 1 10:59:58 2011 +0800

    --MOD   完成除奥科探棒外所有液位仪模块的校罐数据采集处理
    
    	1. 除奥科探棒，所有液位仪模块增加校罐数据采集处理
    	2. 临时数据文件后缀改为csv (tcc_adjust.csv)

commit 6cb84f22b5ac368fd0efe7f12d8f7047a1cc0dc9
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 1 10:16:27 2011 +0800

    --FIX   修正加油量小时液位数据不采集的缺陷
    
    	液位变化判断处理错误

commit c4ed06258a0b068e76826066d6362c41525e0154
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Tue May 31 17:27:39 2011 +0800

    --MOD   校罐项目数据采集处理--补充完善
    
    	1. 增加记录最后一次实时加油数据
    	2. 若采集处理停止即使数据文件大小不到2M也转储到FTP目录中
    	3. 测试后修正若干问题

commit ac399e309939ec1a70981fe122ed152c2e324838
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon May 30 20:35:45 2011 +0800

    --MOD   校罐项目数据采集处理--增加液位仪数据记录(仅TLS2模块)

commit 66a3987a139006c334dcad3aefa8a86598c355af
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon May 30 19:41:25 2011 +0800

    --ADD  添加校罐项目所需的数据采集处理
    
           1. 根据FTP目录log_backup下的start和stop启动和停止数据采集
           2. 数据文件达2M后转储到log_backup:tank_data[YYYYMMDDhhmmss].bak
           3. 记录开始加油时间
           4. 记录交易记录
           5. 记录最后一次实时加油数据                       [未完成]
           6. 记录变化的液位数据--至少改变1mm                [未完成]

commit b9fcb0d13624abb9a3447d15c6c5d927e115fd32
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon May 30 16:23:56 2011 +0800

    --MOD   重庆校罐项目修改版本
    
            1.基于1.06.5503版本
            2.液位仪读取液位数据改为2秒一次;

commit 8745d91d5321c7e330a53b623e4cc747005762b5
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Thu Dec 16 17:12:16 2010 +0800

    --MOD   v1.06.5401 修改二配传状态处理

commit b02b1b90e5a8c1be601437b0112f0ac557129144
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Tue Nov 30 13:40:32 2010 +0800

    --MOD   v1.06.5401 合并1.06.5300-1.06.5400代码
    
            1.06.5401 = 1.06.5400 + "1.06.5303修正油品超过16种后的越界问题"
            [MOD]增加对OPW_ISITE液位仪的支持;
            [ADD]添加李镭的二配B方案dlb_main.c到工程中.

commit 9c8c08eaff9498e07cad746c454c0f9c3c563dc5
Merge: f1b4440 d2045d2
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon Jun 21 17:26:44 2010 +0800

    Merge branch 'master' of ssh://localhost/opt/scm/fcc
    
    Conflicts:
    	src/ifsf_main.h

commit f1b4440112a9509e1a2419bfd495c791c8176906
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 9 20:07:23 2010 +0800

    --MOD   v1.06.5303 修改豪升模块多枪枪号处理(DoEot--gunLog相关)

commit 0559c9d929b5ea96248756fe73822b5f11e7ffb3
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Fri Jun 4 17:57:54 2010 +0800

    --MOD   v1.06.5303 修改写油品时增加油品的处理,修正油品超过16种导致越界问题

commit 2d501becf52ae4b3d36b6cafda3163884fb9d580
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Fri Jun 4 14:48:10 2010 +0800

    --MOD   v1.06.5302 更改ifsf_dsptr.c文件编码

commit 956b8b5d96b5e87716eb55d55637e3ea41e56adb
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 2 18:58:18 2010 +0800

    --MOD   v1.06.5302 修改豪升模块多枪机枪号处理

commit d2045d21433cb674b1b0aaf915159b390b44474d
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Fri Jun 4 17:57:54 2010 +0800

    --MOD   v1.06.5303,修改写油品时增加油品的处理,修正油品超过16种导致越界问题

commit 9a74bd2242c435dc7cb2dce5a8f8f4881898e2dc
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Fri Jun 4 14:48:10 2010 +0800

    --MOD   更改ifsf_dsptr.c文件编码

commit 1317083b32c0fa5d17dad1da6570326179f68ffa
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Wed Jun 2 18:58:18 2010 +0800

    --MOD   v1.06.5302, 修改豪升模块多枪机枪号处理

commit 253fade9427ec0b45dac90eb3e1757833c301a0e
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon Apr 19 17:55:56 2010 +0800

    --MOD   v1.06.5301 转换所有文件为unix格式(dos2unix),去掉^M

commit 2caa8b6b8ed133438f44ff1e9c916b6eb8a9218e
Author: Guojie Zhu <zhugj@css-intelligent.com>
Date:   Mon Apr 19 17:07:54 2010 +0800

    --INIT  初始化FCC项目到GIT仓库,v1.06.5301
